# 剖析CIFS协议     
## CIFS简介     
   Common Internet File System (CIFS)协议，它就是微软维护的SMB协议，是Windows上的共享协议。CIFS协议有三个版本：SMB、SMB2、SMB3，目前SMB和SMB2比较普遍。     
## 客户端与服务器链接：     
### 10.32.200.43打开共享文件\\10.32.106.73\dest\abc.txt时，底层的发生了什么：     
1. TCP三次握手：建立联系（可以看见服务端提供的端口号）     
2. Negotiate（协商）: 客户端把自己支持的所有CIFS版本发送给服务端，服务器把自己支持的最高版本发回复给客户端。     
3. Session Setup（会话）：身份验证，打开\\10.32.106.73。常见的方式有Kerberos和NTLM。     
4.  Tree Conntect（打开\dest）：客户端把Path：\\10.32.106.73\DEST请求给服务器，服务器回复Tree ID给客户端，客户端就可以用这个Tree ID访问\dest的子目录和子文件。           
     
    常见问题1:如果用户没有全权限访问此目录，会不会在Tree Connect这步失败？     
    答案：不会，Tree Connect并不会检查权限。     
    常见问题2：如果用户打开此服务端的另外一个不是其子目录，还需要再建立一个TCP连接吗？     
    答案：不会，在一个TCP连接上能维持多个打开的Tree Connect。     
     
5. 客户端在服务器上查询文件的基本属性、标志属性、扩展属性，还有文件系统信息等。（NTLM比较啰嗦，SMB2会好很多）     
6. Create：新建文件、打开目录、读写文件都需要Create。这个操作会进行权限验证。         
            
    常见问题1：如果只有主目录中子文件的权限，没有主目录的权限，打开子目录会失败吗？            
    答案：如果你通过进入主目录，再进入子目录会收到"Access Denied"报错。但是你可以直接进入子目录。          
     
    常见问题2：Windows的Backup Operators组中的用户有权限备份所有文件，但是不一定有权限读文件。那服务器是怎么知道一个用户是想备份还是想读？     
    答案：备份和读行为的确十分相似，都是依靠Read操作完成的。他们的不同点在备份的Backup Intent为1，读的Backup Intent为0。        
     
    常见问题3：如果多个用户一起访问相同的文件。CIFS如何处理冲突？         
    答案：在Create请求中有Access Mask和Share Access Mask两个选项。前者表示该用户对此文件的访问方式（读、写、删等），后者表示该用户允许其他用户对此文件的访问方式。     
     
    常见问题4：CIFS如何保证缓存数据的一致性？     
    答案：客户端会把文件缓存到本地，等用完之后在同步到服务器。当多用户时，CIFS采用了Oplock（机会锁），Oplock有Exckusive（允许读写缓存）、Batch（允许所有操作的缓存）、Level2（只允许读缓存）。     
    Oplock工作方式：     
    用户A用Exclusive/Batch锁打开某文件，然后缓存了很多修改的文件内容。     
    用户B想读同一个文件，所以发了Create请求给服务器。     
    如果服务器忽略A的Oplock，直接回复B的请求，B则不能看见A修改后的内容（出现的数据不一致）。因此服务器通知A释放Exclusive/Batch锁，换成Level2锁。     
    A立即把缓存里的修改量同步到服务器上。     
    服务器给B回复Create响应，同时授予其Level2锁。B接下来子在发读请求，从而得到A修改后的内容。     
     
7. Read：传输时没有加密。     
    常见问题1：利用Windows Explorer从CIFS共享上复制文件，为什么比Roboccopy和EMCopy之类的工具慢很多。     
    答案：前者是单线程的一次只复制一个文件，后者是多线程的可以复制多个文件。复制一个大文件时可能看不出差别。     
    常见问题2：从CIFS共享里复制一个文件，然后粘贴到同一个目录里，为什么还不如粘贴到客户端的本地硬盘快。     
    答案：前者需要把数据复制到客户端的内存里，再从客户端的内存写到服务器上。后者只需把数据读到客户端内存再写入硬盘中。     
    常见问题3：在CIFS共享上剪切一个文件，然后粘贴到同一共享的子目录里，为什么比粘贴到本地硬盘更快呢？     
    答案：在相同的文件系统上剪切、粘贴、本质上只有"rename"操作,并没有读和写，所以很快。     
    常见问题4：为什么SMB2的性能要好很多？     
    答案：因为SMB2没有SMB在读之前的查询那么多的内容。                                   